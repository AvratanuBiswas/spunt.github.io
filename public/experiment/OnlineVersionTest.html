<!doctype html>
<html>
  <head>
    <title>Dr. Stanley's experiment</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-4.2/jspsych.js"></script>
    <script src="jspsych-4.2/plugins/jspsych-text.js"></script>
    <script src="jspsych-4.2/plugins/jspsych-single-stim.js"></script>
    <link href="jspsych-4.2/css/jspsych.css" rel="stylesheet" type="text/css"></link>
	 <style>
	 			/* Defined Styles */
	 			body {
	 			    background-color: #808080;
	 			    color: black;
	 			    font-weight: 300; 
	 			    font-size: 13pt;
	 			}
				.center-content-1{
					width:850px;
					margin:0 auto;
				}
				.image1{
					width:70% !important;
					margin:2em auto !important;
				}
	 		</style>
	<?php
			// the $_POST[] array will contain the passed in filename and data
			// the directory "data" is writable by the server (chmod 777)
			$filename = "data/".$_POST['filename'];
			$data = $_POST['filedata'];
			// write the file to disk
			file_put_contents($filename, $data);
			?>
  </head>
  <body>
	 
  </body>
  <script>


	/* Section of Code: Images */
	/* Image Pool  */
	/* for AWNB    */
	/* Image Section moved to the beginning so that the the target variable images can be loaded into the instructions    */  

	var nwImgs = ['img/NW/1.png', 'img/NW/2.png', 'img/NW/3.png', 'img/NW/4.png', 'img/NW/5.png', 'img/NW/6.png'];
	var awImgs = ['img/AW/1.png', 'img/AW/2.png', 'img/AW/3.png', 'img/AW/4.png', 'img/AW/5.png', 'img/AW/6.png'];
	var nbImgs = ['img/NB/1.png', 'img/NB/2.png', 'img/NB/3.png', 'img/NB/4.png', 'img/NB/5.png', 'img/NB/6.png'];
	var abImgs = ['img/AB/1.png', 'img/AB/2.png', 'img/AB/3.png', 'img/AB/4.png', 'img/AB/5.png', 'img/AB/6.png'];

	/* Randomized Target Number to Index from    */ 		
	var wTargID = Math.floor(Math.random()*6);
	var bTargID = Math.floor(Math.random()*6);

	/* Randomized Target Image    */ 
	var wTargImg = nwImgs[wTargID];
	var bTargImg = nbImgs[bTargID];

	/* Set Non Target Images    */ 
	var wNonTargImg = awImgs;
	var bNonTargImg = nbImgs;

	/* Remove Target Image from nonTarget Image List    */ 
	wNonTargImg.splice(wTargID,1);
	bNonTargImg.splice(bTargID,1);

	/* Increase Data set to 500 images, 25 each target, 45 each non target    */ 	
	var wTargList = jsPsych.randomization.repeat(wTargImg,25);
	var wNonTargList = jsPsych.randomization.repeat(wNonTargImg,45);
	var bTargList = jsPsych.randomization.repeat(bTargImg,25);
	var bNonTargList = jsPsych.randomization.repeat(bNonTargImg,45);

	/* Combine 500 images into target image list    */ 	
	/* The 500 image list is set    */ 	
	var trialImgList = wTargList.concat(wNonTargList, bTargList, bNonTargList);
	
	/* Randomize images without images repeating     */ 	
	/* Set Variables     */ 	
	var clean;
	var reRand;
	/* Set 500 images     */ 
	var maxReRand = 500;
	var reRandCtr;
	/* Stop infinte loops     */ 	
	while ( 1 ) {
		reRandCtr = 0;
		/*  Images randomized with repeating    */ 
		trialImgOrd = jsPsych.randomization.repeat(trialImgList,1);
		/*  Establishing Conditions    */ 
		for (ind = 1; ind < trialImgOrd.length; ind++ ) {
			if ( trialImgOrd[ind] == trialImgOrd[ind-1] ) {
				clean = trialImgOrd.slice(0,ind);
				reRand = trialImgOrd.slice(ind-trialImgOrd.length);
				reRand = jsPsych.randomization.repeat(reRand,1);
				trialImgOrd = clean.concat(reRand);
				reRandCtr++;
				ind--;
				/*  Break stop the loop if reRandCtr > maxReRand   */ 
				if ( reRandCtr > maxReRand ) {break;}
			}
		}
		if ( ind == trialImgOrd.length ) {break;}
	}

	trialImgOrd = trialImgOrd.slice(0,10);

//GET MID FROM URL
	function getUrlVars() {
	var vars = {};
	var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
	vars[key] = value;
	});
	return vars;
	}

	var MID = getUrlVars()["MID"];

///function for saving data
	function saveData(filename, filedata){
	   $.ajax({
	      type:'post',
	      cache: false,
	      url: 'save_data.php', // this is the path to the above PHP script
	      data: {filename: filename, filedata: filedata}
	   });
	}

	/* 500 Images Preloaded */
	jsPsych.preloadImages(trialImgList, function(){ startExperiment(); }, function(nLoaded) { updateLoadedCount(nLoaded); });

	function updateLoadedCount(nLoaded){
	    var percentcomplete = nLoaded / trialImgList.length * 100;
	    console.log('Loaded '+percentcomplete+'% of trialImgList');
	}

	/*  Section of code: Welcome message */
  var welcome_block = {
      type: "text",
	  text: '<h2 class="center-content-1">Welcome to Your Experiment Dr. Stanley! Press any key to begin.</h2>'+ 
	  // "<div class='image1'><img src='Hdr4.png'></img></div>",
	};
	
	/*  Section of code: Instructions */
	var instructions_block1 = {
      type: "text",
      text:  "<h2>General Instructions:</h2>" +
 
	"<p>Thank you for your participation in this experiment. This research, conducted " +
	"through Caltech, is part of a larger study aimed at how the brain processes " +
	"social information. This research will advance our knowledge about social " +
	"cognition, leading to better services for people with social difficulties.</p> " +
  
	"<p>Throughout this experiment, you should keep in mind that: " +

	"<p>1. Your participation is voluntary. At any point in time, you may choose to " +
	" withdraw consent and discontinue your participation.</p>" +
 
	"<p>2. The information that we collect here will remain private, secure and anonymous.</p> " +
 
	"<p>3. If you have any questions, please do not hesitate to ask the experimenter.</p> " +

	"<p>We truly appreciate and value your time. Thanks! Press any key to continue.</p>", 
     };
	
	
	var instructions_block2 = {
      type: "text",
      text:  "<p>In this task, you will see a rapid presentation of various <strong>black</strong> " +
		  "and <strong>white</strong> faces.</p><p>When the center face on the screen matches either the face " + 
		  "on the left or right, press the B key.</p>" +
          "<div class='left center-content'><img src=" + wTargImg + " style=\"width:160px;height:241px;\"></img>"  +
		
          "<p class='small'><strong>Press the B key</strong></p></div>" +
          "<div class='right center-content'><img src="  + bTargImg + " style=\"width:160px;height:241px;\"></img>"  +
          "<p class='small'><strong>Press the B key</strong></p></div>" +
		  "<p>Keep in mind.</p>" +
		  "<p>*This is different from the previous task. You are NOT sorting black and white " +
		  "faces, but only press the B key when either of the " +
		  "target faces appears in the center of the screen.<p/>" +
		  "<p>*The presentation will go on automatically, and will not stop if you make a " +
		  "mistake.<p/>" +
		  "<p>*The images go by very fast, so it is alright to make some mistakes.<p/>" +
          "<p>Press B to begin.</p>",
    /*  Give slight delay before experiment begins */
      timing_post_trial: 2000
    };
	
	
	
	/* Set Experiment Conditions    */ 		
    var test_block = {
      type: "single-stim",
      stimuli: trialImgOrd,
      choices: ['B'],
	  timing_stim: 400,
      timing_response: 2000,
	  // timing_post_trial: 100,
	  /* Button press does not continue onto next trial    */ 		
      response_ends_trial: false
    };
	
	/* Conclusion    */ 	
	var debrief_block = {
	  type: "text",
	  text: function() {
	    return "<p>Thank you for your participation in your experiment! Press any key to access the measurements.</p>";
	  }
	};

    /* Blocks */
    var experiment = [];
    experiment.push(welcome_block);
	experiment.push(instructions_block1);
    experiment.push(instructions_block2);
    experiment.push(test_block);
	experiment.push(debrief_block);

    /* Run the experiment */
    function startExperiment(){
	jsPsych.init({
      experiment_structure: experiment,
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });
	}
  </script>
</html>